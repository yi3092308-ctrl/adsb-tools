<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADS-B 修正台 (Ultima)</title>
    <style>
        :root {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-primary: #000000;
            --text-secondary: #8e8e93;
            --accent-color: #007AFF;
            --error-color: #ff3b30;
            --warning-color: #ffcc00;
            --success-color: #34c759;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 16px;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            display: grid;
            gap: 16px;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            padding: 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .status-pill {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            background: #eee;
            color: #666;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-pill.live { background: #e8f5e9; color: #2e7d32; }
        .status-pill.error { background: #ffebee; color: #c62828; }
        .status-pill.loading { background: #e3f2fd; color: #1565c0; }

        .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
        .blink { animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.4; } }

        /* Clocks */
        .clock-bar {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .clock-box {
            background: var(--card-bg); /* light theme default */
            padding: 12px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
        }
        .clock-box.dark { background: #2c2c2e; color: white; }
        .clock-label { font-size: 10px; opacity: 0.7; text-transform: uppercase; margin-bottom: 2px; }
        .clock-val { font-size: 22px; font-weight: 600; font-variant-numeric: tabular-nums; }

        /* Panels */
        .panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ebedf0;
        }

        .panel-title { font-size: 16px; font-weight: 600; }
        
        .btn-refresh {
            background: none;
            border: none;
            color: var(--accent-color);
            font-size: 14px;
            font-weight: 500;
            padding: 5px 10px;
            cursor: pointer;
        }
        .btn-refresh:active { opacity: 0.6; }

        /* Inputs */
        .input-row { margin-bottom: 16px; position: relative; }
        .input-row label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        
        input {
            width: 100%;
            padding: 12px;
            font-size: 17px; /* Prevent iOS zoom */
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            background: #f9f9f9;
            box-sizing: border-box;
            -webkit-appearance: none;
        }
        input:focus { border-color: var(--accent-color); background: #fff; outline: none; }
        
        .suffix {
            position: absolute;
            right: 12px;
            top: 38px;
            font-size: 14px;
            color: #8e8e93;
            pointer-events: none;
        }

        /* Search List */
        .search-container { position: relative; }
        .dropdown {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .dropdown div { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        .dropdown div:active { background: #f0f0f0; }

        /* Results */
        .res-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        .res-row:last-child { border-bottom: none; }
        .res-val { font-weight: 600; font-size: 16px; }

        .hero-res {
            background: linear-gradient(135deg, #007AFF, #00C6FF);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 15px;
        }
        .hero-val { font-size: 32px; font-weight: 700; margin: 5px 0; }
        
        /* Debug Info */
        .debug-info { font-size: 10px; color: #999; text-align: right; margin-top: 5px; font-family: monospace; }
        
        /* Hidden advanced */
        #adv-area { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ADS-B 修正台</h1>
        <div id="status-pill" class="status-pill">
            <span class="dot"></span>
            <span id="status-txt">等待输入</span>
        </div>
    </div>

    <div class="clock-bar">
        <div class="clock-box">
            <div class="clock-label">Local</div>
            <div class="clock-val" id="t-local">--:--</div>
        </div>
        <div class="clock-box dark">
            <div class="clock-label">UTC</div>
            <div class="clock-val" id="t-utc">--:--Z</div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <span class="panel-title">参数设置</span>
            <button class="btn-refresh" onclick="forceRefresh()">↻ 刷新数据</button>
        </div>

        <div class="search-container input-row">
            <label>机场代码 (ICAO) 或名称</label>
            <input type="text" id="ipt-icao" placeholder="例如 ZBAA" autocomplete="off">
            <div id="list-dropdown" class="dropdown"></div>
            <div id="airport-name" style="font-size:12px; color:var(--accent-color); margin-top:4px; height:16px;"></div>
        </div>

        <div class="input-row">
            <label>实时修正海压 (QNH)</label>
            <input type="number" id="ipt-qnh" value="1013">
            <span class="suffix">hPa</span>
            <div class="debug-info" id="data-source-info"></div>
        </div>

        <div class="input-row">
            <label>机场标高 (Elevation)</label>
            <input type="number" id="ipt-elev" value="0">
            <span class="suffix">米</span>
        </div>

        <div class="input-row">
            <label>ADS-B 原始读数 (QNE)</label>
            <input type="number" id="ipt-adsb" value="0">
            <span class="suffix">米</span>
        </div>

        <div style="text-align: center; font-size: 12px; color: var(--accent-color); margin-top: 10px;" onclick="toggleAdv()">
            显示高级设置 ▼
        </div>
        <div id="adv-area">
            <div class="input-row">
                <label>气压梯度系数</label>
                <input type="number" id="ipt-coef" value="9.14" step="0.01">
                <span class="suffix">m/hPa</span>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <span class="panel-title">计算结果</span>
        </div>
        <div class="res-row">
            <span>QNH 差值</span>
            <span class="res-val" id="out-diff">0 hPa</span>
        </div>
        <div class="res-row">
            <span>气压修正量</span>
            <span class="res-val" id="out-corr" style="color:var(--accent-color)">+0.00 米</span>
        </div>
        <div class="res-row">
            <span>系统偏置值</span>
            <span class="res-val" id="out-offset">0.00 米</span>
        </div>
        
        <div class="hero-res">
            <div style="font-size:12px; opacity:0.8">飞机相对高度 (AGL)</div>
            <div class="hero-val" id="out-final">0</div>
            <div style="font-size:12px; opacity:0.8">Meters</div>
        </div>
    </div>
</div>

<script>
    // === 1. 数据配置 ===
    const airports = [
        {c:"ZBAA",n:"北京首都",ct:"Beijing"},{c:"ZBAD",n:"北京大兴",ct:"Beijing"},
        {c:"ZSSS",n:"上海虹桥",ct:"Shanghai"},{c:"ZSPD",n:"上海浦东",ct:"Shanghai"},
        {c:"ZGGG",n:"广州白云",ct:"Guangzhou"},{c:"ZGSZ",n:"深圳宝安",ct:"Shenzhen"},
        {c:"ZUUU",n:"成都天府",ct:"Chengdu"},{c:"ZPPP",n:"昆明长水",ct:"Kunming"},
        {c:"ZXYA",n:"西安咸阳",ct:"Xi'an"},{c:"ZUCK",n:"重庆江北",ct:"Chongqing"},
        {c:"ZHZH",n:"杭州萧山",ct:"Hangzhou"},{c:"ZSNJ",n:"南京禄口",ct:"Nanjing"},
        {c:"ZHHH",n:"武汉天河",ct:"Wuhan"},{c:"ZGHA",n:"长沙黄花",ct:"Changsha"},
        {c:"VHHH",n:"香港 HKG",ct:"HongKong"},{c:"VMMC",n:"澳门 MFM",ct:"Macau"},
        {c:"RCTP",n:"台北桃园",ct:"Taipei"},{c:"RJTT",n:"东京羽田",ct:"Tokyo"},
        {c:"WSSS",n:"新加坡 SIN",ct:"Singapore"},{c:"KJFK",n:"纽约 JFK",ct:"NewYork"},
        {c:"EGLL",n:"伦敦 LHR",ct:"London"},{c:"OMDB",n:"迪拜 DXB",ct:"Dubai"}
    ];

    let currentIcao = "";
    let lastFetchTime = 0;

    // === 2. 核心网络引擎 (Multi-Source Fetcher) ===
    async function fetchMetar(icao) {
        if(!icao || icao.length !== 4) return;
        
        const ui = {
            status: document.getElementById('status-pill'),
            txt: document.getElementById('status-txt'),
            dot: document.querySelector('.dot'),
            info: document.getElementById('data-source-info')
        };

        // UI 设为加载中
        ui.status.className = "status-pill loading";
        ui.txt.textContent = "正在连接气象源...";
        ui.dot.className = "dot blink";
        ui.info.textContent = "";

        // 构造请求链 (Waterfall Strategy)
        // 关键：加 timestamp 防止 iOS 缓存
        const ts = Date.now();
        const sources = [
            {
                name: "Vatsim (Fast)", 
                url: `https://metar.vatsim.net/metar.php?id=${icao}&t=${ts}` 
                // VATSIM 是唯一原生支持 CORS 的开放源，速度最快
            },
            {
                name: "Proxy A (IO)", 
                url: `https://corsproxy.io/?https://tgftp.nws.noaa.gov/data/observations/metar/stations/${icao}.TXT?t=${ts}`
            },
            {
                name: "Proxy B (AO)", 
                url: `https://api.allorigins.win/raw?url=${encodeURIComponent(`https://tgftp.nws.noaa.gov/data/observations/metar/stations/${icao}.TXT?t=${ts}`)}`
            }
        ];

        let success = false;
        let metarText = "";
        let usedSource = "";

        for (let src of sources) {
            try {
                ui.info.textContent = `尝试: ${src.name}...`;
                console.log(`Trying ${src.name}...`);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒超时
                
                const res = await fetch(src.url, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (res.ok) {
                    const text = await res.text();
                    // 简单验证是否是有效 METAR (必须包含 ICAO)
                    if (text.includes(icao) || text.length > 10) {
                        metarText = text;
                        usedSource = src.name;
                        success = true;
                        break; // 成功即跳出循环
                    }
                }
            } catch (e) {
                console.warn(`${src.name} failed:`, e);
            }
        }

        if (success) {
            parseAndSet(metarText, usedSource);
            ui.status.className = "status-pill live";
            ui.txt.textContent = "数据已更新";
            ui.dot.className = "dot";
        } else {
            ui.status.className = "status-pill error";
            ui.txt.textContent = "所有线路均失败";
            ui.dot.className = "dot";
            ui.info.textContent = "请检查手机网络或稍后重试";
        }
    }

    // === 3. 数据解析 ===
    function parseAndSet(text, sourceName) {
        // 1. 找 QNH (Qxxxx)
        let qMatch = text.match(/Q(\d{4})/);
        let qnh = 0;

        if (qMatch) {
            qnh = parseInt(qMatch[1]);
        } else {
            // 2. 找 Altimeter (Axxxx) 美国标准
            let aMatch = text.match(/A(\d{4})/);
            if (aMatch) {
                // 英寸汞柱转hPa
                qnh = Math.round(parseInt(aMatch[1]) / 100 * 33.8639);
            }
        }

        if (qnh > 800 && qnh < 1100) {
            document.getElementById('ipt-qnh').value = qnh;
            
            // 提取时间 DDHHMMZ
            let timeStr = "";
            let tMatch = text.match(/\d{6}Z/);
            if(tMatch) timeStr = tMatch[0];

            document.getElementById('data-source-info').textContent = 
                `源: ${sourceName} | 报文: ${timeStr} | QNH: ${qnh}`;
            
            lastFetchTime = Date.now();
            calc();
        } else {
            document.getElementById('data-source-info').textContent = "报文解析失败: 无压力数据";
        }
    }

    // === 4. 计算引擎 ===
    function calc() {
        const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
        
        const qnh = getVal('ipt-qnh') || 1013;
        const elev = getVal('ipt-elev');
        const adsb = getVal('ipt-adsb');
        const coef = getVal('ipt-coef') || 9.14;

        // 逻辑
        const diff = qnh - 1013.25;
        const correction = diff * coef;
        const offset = correction - elev; // 系统偏置 = 气压修正 - 海拔
        const final = adsb + correction - elev; // 飞机相对高度 = ADS-B + 修正 - 海拔

        // 输出
        document.getElementById('out-diff').textContent = (diff>0?"+":"") + diff.toFixed(1) + " hPa";
        document.getElementById('out-corr').textContent = (diff>0?"+":"") + correction.toFixed(1) + " 米";
        document.getElementById('out-offset').textContent = (offset>0?"+":"") + offset.toFixed(1) + " 米";
        document.getElementById('out-final').textContent = Math.round(final); // 取整显示更直观
    }

    // === 5. 交互逻辑 ===
    // 监听输入自动计算
    ['ipt-qnh', 'ipt-elev', 'ipt-adsb', 'ipt-coef'].forEach(id => {
        document.getElementById(id).addEventListener('input', calc);
    });

    // 搜索框逻辑
    const iptIcao = document.getElementById('ipt-icao');
    const drop = document.getElementById('list-dropdown');
    
    iptIcao.addEventListener('input', (e) => {
        const val = e.target.value.toUpperCase();
        drop.innerHTML = "";
        
        if(!val) { document.getElementById('airport-name').textContent = ""; return; }

        const hits = airports.filter(a => a.c.includes(val) || a.n.includes(val) || a.ct.toUpperCase().includes(val));
        
        hits.forEach(a => {
            const div = document.createElement('div');
            div.innerHTML = `<b>${a.c}</b> - ${a.ct} ${a.n}`;
            div.onclick = () => {
                iptIcao.value = a.c;
                currentIcao = a.c;
                document.getElementById('airport-name').textContent = `${a.ct} ${a.n}`;
                drop.innerHTML = "";
                fetchMetar(currentIcao);
            };
            drop.appendChild(div);
        });

        // 允许手动输入
        if(val.length === 4 && hits.length === 0) {
            currentIcao = val;
            clearTimeout(window.tmr);
            window.tmr = setTimeout(() => fetchMetar(val), 800);
        }
    });

    // 点击外部关闭下拉
    document.addEventListener('click', (e) => {
        if(e.target !== iptIcao) drop.innerHTML = "";
    });

    // 高级设置开关
    function toggleAdv() {
        const el = document.getElementById('adv-area');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
    }

    // 强制刷新
    function forceRefresh() {
        if(currentIcao) fetchMetar(currentIcao);
        else document.getElementById('ipt-icao').focus();
    }

    // === 6. 自动唤醒更新 (核心修复) ===
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible') {
            const now = Date.now();
            // 如果数据超过10分钟且有机场代码，唤醒立即刷新
            if (currentIcao && (now - lastFetchTime > 600000)) {
                fetchMetar(currentIcao);
            }
        }
    });

    // === 7. 时钟 ===
    setInterval(() => {
        const now = new Date();
        document.getElementById('t-local').textContent = now.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('t-utc').textContent = now.toISOString().substring(11, 16) + 'Z';
    }, 1000);

    calc(); // Init
</script>

</body>
</html>
