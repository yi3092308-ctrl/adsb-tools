<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADS-B 修正台 V5</title>
    <style>
        :root {
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-color: #0066cc;
            --accent-gradient: linear-gradient(135deg, #0066cc, #0099ff);
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --radius: 18px;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 15px;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 1. 顶部时间与天气卡片 (布局调整) */
        .info-card {
            background: var(--card-bg);
            padding: 25px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center; /* 核心修改：居中 */
        }

        .local-time-group {
            margin-bottom: 20px;
        }
        .time-big {
            font-size: 32px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.5px;
            line-height: 1;
            margin-bottom: 5px;
        }
        .date-full {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* 天气栅格优化 */
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 手机端两列 */
            gap: 15px;
            border-top: 1px solid #f0f0f0;
            padding-top: 20px;
            text-align: left; /* 内部文字左对齐更易读 */
        }
        @media (min-width: 400px) {
            .weather-grid { grid-template-columns: repeat(4, 1fr); text-align: center; } /* 宽屏4列居中 */
        }

        .wx-item {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .wx-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .wx-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
        }
        .wx-sub {
            font-size: 11px;
            font-weight: 400;
            color: #888;
        }
        .wx-placeholder {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 13px;
            color: #ccc;
            padding: 10px;
        }

        /* 2. 主操作面板 */
        .main-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .section-header {
            background: #fafafa;
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--radius) var(--radius) 0 0;
        }
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #555;
            letter-spacing: 0.5px;
        }
        .status-badge {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 12px;
            background: #eee;
            color: #999;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-badge.live { background: #e8f5e9; color: var(--success-color); }
        .status-badge.error { background: #ffebee; color: var(--danger-color); }

        .panel-body { padding: 20px; }

        /* 输入框通用 */
        .input-group { position: relative; margin-bottom: 18px; }
        .input-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        input {
            width: 100%;
            padding: 14px;
            padding-right: 45px;
            font-size: 18px;
            border: 1px solid #e1e1e1;
            border-radius: 12px;
            background: #f9f9f9;
            box-sizing: border-box;
            -webkit-appearance: none;
            font-weight: 600;
            color: var(--text-primary);
        }
        input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(0,102,204,0.1);
        }
        .unit {
            position: absolute;
            right: 15px;
            top: 50%; /* Adjusted logic in HTML structure */
            transform: translateY(18px); /* Mock vertical align relative to label+input */
            color: #999;
            font-size: 14px;
            pointer-events: none;
        }
        /* Fix unit pos */
        .input-wrapper { position: relative; }
        .input-wrapper .unit { top: 50%; transform: translateY(-50%); }

        /* 搜索下拉 */
        .search-dropdown {
            position: absolute;
            top: 105%; left: 0; right: 0;
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            z-index: 999;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        .search-item {
            padding: 14px 15px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 15px;
            cursor: pointer;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:active { background: #f5f5f7; }

        /* 数据行 */
        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #eee;
        }
        .data-label { font-size: 14px; color: var(--text-secondary); }
        .data-val { font-size: 18px; font-weight: 600; }
        
        /* 结果卡片 */
        .highlight-card {
            background: var(--accent-gradient);
            color: white;
            padding: 22px;
            border-radius: 14px;
            text-align: center;
            margin-top: 10px;
            box-shadow: 0 8px 20px rgba(0, 102, 204, 0.25);
        }
        .highlight-val { font-size: 42px; font-weight: 700; margin: 5px 0; letter-spacing: -1px; }

        /* 高级设置 */
        .advanced-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
        }
        .advanced-toggle {
            padding: 18px 20px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .advanced-content {
            padding: 0 20px 20px 20px;
            display: none;
            border-top: 1px solid #f5f5f5;
        }
        .advanced-content.show { display: block; animation: slide 0.3s; }
        @keyframes slide { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

        .dot { display: inline-block; width: 6px; height: 6px; background: currentColor; border-radius: 50%; }
        .blink { animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.3; } }
    </style>
</head>
<body>

<div class="container">

    <!-- 1. 顶部时间与天气 (已居中) -->
    <div class="info-card">
        <div class="local-time-group">
            <div class="time-big" id="clock-time">--:--</div>
            <div class="date-full" id="clock-date">初始化中...</div>
        </div>
        
        <div class="weather-grid" id="weather-box">
            <div class="wx-placeholder">请在下方搜索机场以获取天气详情</div>
        </div>
    </div>

    <!-- 2. 核心面板 (排序：搜索 -> QNH -> 偏置 -> ADSB -> 结果) -->
    <div class="main-panel">
        <div class="section-header">
            <span class="section-title">参数修正</span>
            <div class="status-badge" id="status-badge">
                <span class="dot" id="status-dot"></span>
                <span id="status-text" style="margin-left:5px">待机</span>
            </div>
        </div>
        
        <div class="panel-body">
            <!-- A. 搜索 (首位) -->
            <div class="input-group" style="z-index: 20;">
                <label class="input-label">
                    <span>机场搜索 (ICAO / 城市)</span>
                    <span id="refresh-btn" style="color:var(--accent-color); cursor:pointer;">↻ 刷新数据</span>
                </label>
                <div class="input-wrapper">
                    <input type="text" id="ipt-search" placeholder="输入代码 如 ZBAA" autocomplete="off">
                    <div id="search-results" class="search-dropdown"></div>
                </div>
                <div id="airport-display" style="font-size:12px; color:var(--accent-color); margin-top:6px; font-weight:500; min-height:16px;"></div>
            </div>

            <!-- B. QNH (次位) -->
            <div class="input-group">
                <div class="input-label">
                    <span>实时修正海压 (QNH)</span>
                    <span id="qnh-time" style="font-weight:normal; opacity:0.6; font-size:11px;"></span>
                </div>
                <div class="input-wrapper">
                    <input type="number" id="ipt-qnh" value="1013">
                    <span class="unit">hPa</span>
                </div>
            </div>

            <!-- C. 偏置值 (自动计算) -->
            <div class="data-row">
                <div class="data-label">
                    系统偏置值 (Correction)
                    <div style="font-size:10px; opacity:0.6; margin-top:2px;">ADS-B气压高度误差量</div>
                </div>
                <div class="data-val" id="res-offset" style="color: var(--text-primary);">0.00 米</div>
            </div>

            <div style="border-top: 1px solid #f0f0f0; margin: 15px 0;"></div>

            <!-- D. ADS-B 输入 -->
            <div class="input-group">
                <label class="input-label">ADS-B 原始读数 (QNE)</label>
                <div class="input-wrapper">
                    <input type="number" id="ipt-adsb" placeholder="输入屏幕显示高度">
                    <span class="unit">米</span>
                </div>
            </div>

            <!-- E. 结果 -->
            <div class="highlight-card">
                <div style="font-size:13px; opacity:0.9; margin-bottom:5px;">飞机相对高度 (AGL)</div>
                <div class="highlight-val" id="res-final">0</div>
                <div style="font-size:12px; opacity:0.8;">Meters (已扣除海拔)</div>
            </div>
        </div>
    </div>

    <!-- 3. 高级设置 -->
    <div class="advanced-panel">
        <div class="advanced-toggle" onclick="toggleAdv()">
            <span>⚙️ 高级参数设置 (标高/系数)</span>
            <span id="adv-arrow">▼</span>
        </div>
        <div class="advanced-content" id="adv-content">
            <div class="input-group" style="margin-top:10px;">
                <label class="input-label">机场标高 (Elevation)</label>
                <div class="input-wrapper">
                    <input type="number" id="ipt-elev" value="0">
                    <span class="unit">米</span>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">标准气压 (QNE)</label>
                <div class="input-wrapper">
                    <input type="number" id="ipt-qne" value="1013.25">
                    <span class="unit">hPa</span>
                </div>
            </div>
            <div class="input-group" style="margin-bottom:0;">
                <label class="input-label">气压梯度系数</label>
                <div class="input-wrapper">
                    <input type="number" id="ipt-coef" value="8.3" step="0.1">
                    <span class="unit">m/hPa</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ===================================
    // 1. 数据配置
    // ===================================
    const airports = [
        {c:"ZBAA",n:"北京首都",ct:"Beijing"},{c:"ZBAD",n:"北京大兴",ct:"Beijing"},
        {c:"ZSSS",n:"上海虹桥",ct:"Shanghai"},{c:"ZSPD",n:"上海浦东",ct:"Shanghai"},
        {c:"ZGGG",n:"广州白云",ct:"Guangzhou"},{c:"ZGSZ",n:"深圳宝安",ct:"Shenzhen"},
        {c:"ZUUU",n:"成都天府",ct:"Chengdu"},{c:"ZPPP",n:"昆明长水",ct:"Kunming"},
        {c:"ZXYA",n:"西安咸阳",ct:"Xi'an"},{c:"ZUCK",n:"重庆江北",ct:"Chongqing"},
        {c:"ZHZH",n:"杭州萧山",ct:"Hangzhou"},{c:"ZSNJ",n:"南京禄口",ct:"Nanjing"},
        {c:"ZHHH",n:"武汉天河",ct:"Wuhan"},{c:"ZGHA",n:"长沙黄花",ct:"Changsha"},
        {c:"VHHH",n:"香港 HKG",ct:"HongKong"},{c:"VMMC",n:"澳门 MFM",ct:"Macau"},
        {c:"RCTP",n:"台北桃园",ct:"Taipei"},{c:"RJTT",n:"东京羽田",ct:"Tokyo"},
        {c:"WSSS",n:"新加坡 SIN",ct:"Singapore"},{c:"KJFK",n:"纽约 JFK",ct:"NewYork"},
        {c:"EGLL",n:"伦敦 LHR",ct:"London"},{c:"OMDB",n:"迪拜 DXB",ct:"Dubai"}
    ];

    let currentIcao = "";
    let lastFetchTime = 0;

    // ===================================
    // 2. 时钟逻辑 (居中显示)
    // ===================================
    function updateClock() {
        const now = new Date();
        const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
        document.getElementById('clock-time').textContent = now.toLocaleTimeString('zh-CN', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
        document.getElementById('clock-date').textContent = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${days[now.getDay()]}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // ===================================
    // 3. 核心计算
    // ===================================
    function calc() {
        const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
        
        const qnh = getVal('ipt-qnh');
        const qne = getVal('ipt-qne');
        const elev = getVal('ipt-elev');
        const adsb = getVal('ipt-adsb');
        const coef = getVal('ipt-coef');
        
        const diff = qnh - qne;
        const correction = diff * coef;
        const offset = correction - elev; 
        const final = adsb + offset;

        const offsetEl = document.getElementById('res-offset');
        offsetEl.textContent = (offset > 0 ? "+" : "") + offset.toFixed(2) + " 米";
        offsetEl.style.color = offset >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

        document.getElementById('res-final').textContent = Math.round(final);
    }

    ['ipt-qnh', 'ipt-adsb', 'ipt-elev', 'ipt-qne', 'ipt-coef'].forEach(id => {
        document.getElementById(id).addEventListener('input', calc);
    });

    // ===================================
    // 4. 网络请求
    // ===================================
    async function fetchMetar(icao) {
        if(!icao) return;
        
        const ui = {
            badge: document.getElementById('status-badge'),
            dot: document.getElementById('status-dot'),
            txt: document.getElementById('status-text')
        };

        ui.badge.className = "status-badge";
        ui.txt.textContent = "更新中...";
        ui.dot.className = "dot blink";

        const ts = Date.now();
        const url = `https://metar.vatsim.net/metar.php?id=${icao}&t=${ts}`; // Primary
        const proxyUrl = `https://corsproxy.io/?https://tgftp.nws.noaa.gov/data/observations/metar/stations/${icao}.TXT?t=${ts}`; // Backup

        try {
            let res = await fetch(url);
            if(!res.ok) throw new Error("Vatsim fail");
            let text = await res.text();
            
            if(text && text.includes(icao)) {
                success(text, "实时");
            } else {
                throw new Error("Invalid");
            }
        } catch (e) {
            console.log("Backup try...");
            try {
                let res2 = await fetch(proxyUrl);
                let text2 = await res2.text();
                if(text2.length > 10) success(text2, "备用源");
                else throw new Error("All fail");
            } catch(e2) {
                ui.badge.className = "status-badge error";
                ui.txt.textContent = "失败(检查网络)";
                ui.dot.className = "dot";
            }
        }

        function success(raw, src) {
            ui.badge.className = "status-badge live";
            ui.txt.textContent = src + "数据";
            ui.dot.className = "dot";
            lastFetchTime = Date.now();
            parseMetarEnhanced(raw);
            calc();
        }
    }

    // ===================================
    // 5. 增强版气象解析 (汉化+风级)
    // ===================================
    function parseMetarEnhanced(raw) {
        // 1. QNH
        let qnh = 1013;
        let qMatch = raw.match(/Q(\d{4})/);
        if(qMatch) qnh = parseInt(qMatch[1]);
        else {
            let aMatch = raw.match(/A(\d{4})/);
            if(aMatch) qnh = Math.round(parseInt(aMatch[1])/100 * 33.8639);
        }
        document.getElementById('ipt-qnh').value = qnh;
        let tMatch = raw.match(/(\d{2})(\d{4})Z/);
        if(tMatch) document.getElementById('qnh-time').textContent = `(报文: ${tMatch[2]}Z)`;

        // 清空天气盘
        const wxBox = document.getElementById('weather-box');
        wxBox.innerHTML = "";

        // --- A. 智能天气现象 (汉化) ---
        let wxDesc = "晴 / 良好";
        // 优先级：重要天气 > 云量 > 晴
        if (raw.match(/(RA|DZ)/)) wxDesc = "雨";
        if (raw.match(/SN/)) wxDesc = "雪";
        if (raw.match(/TS/)) wxDesc = "雷雨";
        if (raw.match(/(FG|BR)/)) wxDesc = "雾/薄雾";
        if (raw.match(/HZ/)) wxDesc = "霾";
        
        if (wxDesc === "晴 / 良好") {
            if (raw.match(/OVC/)) wxDesc = "阴天 (Overcast)";
            else if (raw.match(/BKN/)) wxDesc = "多云 (Broken)";
            else if (raw.match(/SCT/)) wxDesc = "少云 (Scattered)";
            else if (raw.match(/FEW/)) wxDesc = "晴间多云";
            else if (raw.match(/CAVOK/)) wxDesc = "晴 (CAVOK)";
        }
        addWxItem("天气现象", wxDesc, raw.match(/(RA|SN|TS|FG|OVC|BKN|CAVOK)/)?.[0] || "--");

        // --- B. 风向风速 (增强版) ---
        let windStr = "静风";
        let windSub = "0m/s";
        let wMatch = raw.match(/(\d{3}|VRB)(\d{2,3})(KT|MPS)/);
        if(wMatch) {
            let degRaw = wMatch[1];
            let spdRaw = parseInt(wMatch[2]);
            let unit = wMatch[3];
            
            // 速度换算 m/s
            let mps = (unit === "KT") ? spdRaw * 0.51444 : spdRaw;
            
            // 蒲福风级
            let level = 0;
            if(mps < 0.3) level = 0;
            else if(mps <= 1.5) level = 1;
            else if(mps <= 3.3) level = 2;
            else if(mps <= 5.4) level = 3;
            else if(mps <= 7.9) level = 4;
            else if(mps <= 10.7) level = 5;
            else if(mps <= 13.8) level = 6;
            else if(mps <= 17.1) level = 7;
            else level = 8; // 简化 >8

            // 方位换算
            let dirTxt = "";
            if(degRaw === "VRB") {
                dirTxt = "不定向";
            } else {
                let deg = parseInt(degRaw);
                const dirs = ["北风", "东北风", "东风", "东南风", "南风", "西南风", "西风", "西北风", "北风"];
                let idx = Math.round(deg / 45);
                dirTxt = dirs[idx] + " " + deg + "°";
            }

            windStr = `${dirTxt}`;
            windSub = `${level}级 (${mps.toFixed(1)}m/s)`;
        }
        addWxItem("风向风力", windStr, windSub);

        // --- C. 温度湿度 ---
        let tmMatch = raw.match(/(M?\d{2})\/(M?\d{2})/);
        if(tmMatch) {
            let t = parseInt(tmMatch[1].replace('M','-'));
            let td = parseInt(tmMatch[2].replace('M','-'));
            let hum = 100 - 5 * (t - td); // 近似
            addWxItem("温度", t + "°C");
            addWxItem("相对湿度", "~" + hum + "%");
        }
    }

    function addWxItem(label, val, sub="") {
        const div = document.createElement('div');
        div.className = "wx-item";
        div.innerHTML = `
            <div class="wx-label">${label}</div>
            <div class="wx-value">${val}</div>
            ${sub ? `<div class="wx-sub">${sub}</div>` : ''}
        `;
        document.getElementById('weather-box').appendChild(div);
    }

    // ===================================
    // 6. 交互逻辑
    // ===================================
    const iptSearch = document.getElementById('ipt-search');
    const dropdown = document.getElementById('search-results');
    
    iptSearch.addEventListener('input', (e) => {
        const val = e.target.value.toUpperCase();
        dropdown.innerHTML = "";
        
        if(!val) { 
            dropdown.style.display = 'none'; 
            document.getElementById('airport-display').textContent = "";
            return; 
        }

        const hits = airports.filter(a => a.c.includes(val) || a.n.includes(val) || a.ct.toUpperCase().includes(val));
        
        if(hits.length > 0) {
            dropdown.style.display = 'block';
            hits.forEach(a => {
                const div = document.createElement('div');
                div.className = "search-item";
                div.innerHTML = `<strong>${a.c}</strong> - ${a.ct} ${a.n}`;
                div.onclick = () => selectAirport(a);
                dropdown.appendChild(div);
            });
        } else if(val.length === 4) {
            dropdown.style.display = 'block';
            const div = document.createElement('div');
            div.className = "search-item";
            div.innerHTML = `自定义代码: <strong>${val}</strong>`;
            div.onclick = () => selectAirport({c:val, n:"自定义", ct:""});
            dropdown.appendChild(div);
        } else {
            dropdown.style.display = 'none';
        }
    });

    function selectAirport(a) {
        iptSearch.value = a.c;
        currentIcao = a.c;
        document.getElementById('airport-display').textContent = `${a.ct} ${a.n}`;
        dropdown.style.display = 'none';
        fetchMetar(currentIcao);
    }

    document.getElementById('refresh-btn').onclick = () => {
        if(currentIcao) fetchMetar(currentIcao);
        else iptSearch.focus();
    };

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible' && currentIcao) {
            if(Date.now() - lastFetchTime > 600000) fetchMetar(currentIcao);
        }
    });

    document.addEventListener('click', (e) => {
        if(e.target !== iptSearch) dropdown.style.display = 'none';
    });

    function toggleAdv() {
        const content = document.getElementById('adv-content');
        const arrow = document.getElementById('adv-arrow');
        if(content.style.display === 'block') {
            content.classList.remove('show');
            setTimeout(()=> content.style.display = 'none', 100);
            arrow.textContent = "▼";
        } else {
            content.style.display = 'block';
            setTimeout(()=> content.classList.add('show'), 10);
            arrow.textContent = "▲";
        }
    }

    calc();
</script>

</body>
</html>
