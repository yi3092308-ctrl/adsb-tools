<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADS-B 修正台 V5.3</title>
    <style>
        :root {
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-color: #0066cc;
            --accent-gradient: linear-gradient(135deg, #0066cc, #0099ff);
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --warning-color: #ff9f0a;
            --radius: 18px;
            --shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 15px;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 1. 顶部时间与天气 */
        .info-card {
            background: var(--card-bg);
            padding: 25px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .local-time-group { margin-bottom: 20px; }
        .time-big {
            font-size: 32px;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.5px;
            line-height: 1;
            margin-bottom: 5px;
        }
        .date-full { font-size: 14px; color: var(--text-secondary); font-weight: 500; }

        .weather-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            border-top: 1px solid #f0f0f0;
            padding-top: 20px;
            text-align: left;
        }
        @media (min-width: 400px) { .weather-grid { grid-template-columns: repeat(4, 1fr); text-align: center; } }

        .wx-item { display: flex; flex-direction: column; justify-content: center; }
        .wx-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; }
        .wx-value { font-size: 15px; font-weight: 600; color: var(--text-primary); line-height: 1.3; }
        .wx-sub { font-size: 11px; font-weight: 400; color: #888; }
        .wx-placeholder { grid-column: 1 / -1; text-align: center; font-size: 13px; color: #ccc; padding: 10px; }

        /* 2. 主操作面板 */
        .main-panel {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .section-header {
            background: #fafafa;
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--radius) var(--radius) 0 0;
        }
        .section-title { font-size: 14px; font-weight: 700; color: #555; }
        
        .status-badge {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 12px;
            background: #eee;
            color: #999;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        .status-badge.live { background: #e8f5e9; color: var(--success-color); }
        .status-badge.error { background: #ffebee; color: var(--danger-color); }
        .status-badge.loading { background: #e3f2fd; color: var(--accent-color); }

        .panel-body { padding: 20px; }

        .input-group { position: relative; margin-bottom: 18px; }
        .input-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .input-wrapper { position: relative; }
        
        input {
            width: 100%;
            padding: 14px;
            padding-right: 45px;
            font-size: 18px;
            border: 1px solid #e1e1e1;
            border-radius: 12px;
            background: #f9f9f9;
            box-sizing: border-box;
            -webkit-appearance: none;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.3s, border-color 0.3s;
        }
        input:focus { outline: none; border-color: var(--accent-color); background: #fff; box-shadow: 0 0 0 4px rgba(0,102,204,0.1); }
        
        /* 告警状态样式 */
        input.alert {
            color: var(--danger-color);
            border-color: var(--danger-color);
            background: #fff5f5;
        }

        .unit { 
            position: absolute; 
            right: 15px; 
            top: 0; bottom: 0; margin: auto; 
            height: 20px; 
            line-height: 20px;
            color: #999; font-size: 14px; pointer-events: none; 
        }

        .search-dropdown {
            position: absolute;
            top: 105%; left: 0; right: 0;
            background: white;
            border: 1px solid #eee;
            border-radius: 12px;
            z-index: 999;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            max-height: 250px;
            overflow-y: auto;
            display: none;
        }
        .search-item { padding: 14px 15px; border-bottom: 1px solid #f5f5f5; font-size: 15px; cursor: pointer; }
        .search-item:active { background: #f0f7ff; }
        .search-item strong { color: var(--accent-color); }

        .data-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .data-label { font-size: 14px; color: var(--text-secondary); }
        .data-val { font-size: 18px; font-weight: 600; }
        
        .highlight-card {
            background: var(--accent-gradient);
            color: white;
            padding: 22px;
            border-radius: 14px;
            text-align: center;
            margin-top: 10px;
            box-shadow: 0 8px 20px rgba(0, 102, 204, 0.25);
        }
        .highlight-val { font-size: 42px; font-weight: 700; margin: 5px 0; letter-spacing: -1px; }

        .advanced-panel { background: var(--card-bg); border-radius: var(--radius); }
        .advanced-toggle { padding: 18px 20px; font-size: 13px; color: var(--text-secondary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .advanced-content { padding: 0 20px 20px 20px; display: none; border-top: 1px solid #f5f5f5; }
        .advanced-content.show { display: block; animation: slide 0.3s; }
        @keyframes slide { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

        .dot { display: inline-block; width: 6px; height: 6px; background: currentColor; border-radius: 50%; }
        .blink { animation: pulse 0.8s infinite; }
        @keyframes pulse { 50% { opacity: 0.3; } }

        /* 倒计时微调 */
        .timer-badge {
            font-size: 11px;
            color: var(--success-color);
            background: #e8f5e9;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .timer-badge.stale { color: var(--warning-color); background: #fff8e1; }
        .timer-badge.error { color: var(--danger-color); background: #ffebee; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">

    <!-- 1. 顶部时间与天气 -->
    <div class="info-card">
        <div class="local-time-group">
            <div class="time-big" id="clock-time">--:--</div>
            <div class="date-full" id="clock-date">初始化中...</div>
        </div>
        
        <div class="weather-grid" id="weather-box">
            <div class="wx-placeholder">请在下方搜索机场以获取天气详情</div>
        </div>
    </div>

    <!-- 2. 核心面板 -->
    <div class="main-panel">
        <div class="section-header">
            <span class="section-title">参数修正</span>
            <div class="status-badge" id="status-badge">
                <span class="dot" id="status-dot"></span>
                <span id="status-text" style="margin-left:5px">待机</span>
            </div>
        </div>
        
        <div class="panel-body">
            <!-- 搜索 -->
            <div class="input-group" style="z-index: 20;">
                <label class="input-label">
                    <span>机场搜索 (ICAO / 城市)</span>
                    <span id="refresh-btn" style="color:var(--accent-color); cursor:pointer;">↻ 刷新</span>
                </label>
                <div class="input-wrapper">
                    <input type="text" id="ipt-search" placeholder="输入城市(如:北京) 或 代码(ZBAA)" autocomplete="off">
                    <div id="search-results" class="search-dropdown"></div>
                </div>
                <!-- 修复显示位置 -->
                <div id="airport-display" style="font-size:12px; color:var(--accent-color); margin-top:6px; font-weight:500; min-height:16px;"></div>
            </div>

            <!-- QNH (倒计时移至此处) -->
            <div class="input-group">
                <div class="input-label">
                    <span>实时修正海压 (QNH)</span>
                    <!-- 倒计时显示区 -->
                    <span id="update-timer" class="timer-badge" style="display:none;"></span>
                </div>
                <div class="input-wrapper">
                    <input type="number" id="ipt-qnh" value="1013">
                    <span class="unit">hPa</span>
                </div>
            </div>

            <!-- 偏置值 -->
            <div class="data-row">
                <div class="data-label">
                    系统偏置值 (Correction)
                    <div style="font-size:10px; opacity:0.6; margin-top:2px;">ADS-B气压高度误差量</div>
                </div>
                <div class="data-val" id="res-offset" style="color: var(--text-primary);">0.00 米</div>
            </div>

            <div style="border-top: 1px solid #f0f0f0; margin: 15px 0;"></div>

            <!-- ADS-B 输入 -->
            <div class="input-group">
                <label class="input-label">ADS-B 原始读数 (QNE)</label>
                <div class="input-wrapper">
                    <input type="number" id="ipt-adsb" placeholder="输入屏幕显示高度">
                    <span class="unit">米</span>
                </div>
            </div>

            <!-- 结果 -->
            <div class="highlight-card">
                <div style="font-size:13px; opacity:0.9; margin-bottom:5px;">飞机相对高度 (AGL)</div>
                <div class="highlight-val" id="res-final">0</div>
                <div style="font-size:12px; opacity:0.8;">Meters (已扣除海拔)</div>
            </div>
        </div>
    </div>

    <!-- 3. 高级设置 -->
    <div class="advanced-panel">
        <div class="advanced-toggle" onclick="toggleAdv()">
            <span>⚙️ 高级参数设置 (标高/系数)</span>
            <span id="adv-arrow">▼</span>
        </div>
        <div class="advanced-content" id="adv-content">
            <div class="input-group" style="margin-top:10px;">
                <label class="input-label">机场标高 (Elevation)</label>
                <div class="input-wrapper">
                    <input type="number" id="ipt-elev" value="0">
                    <span class="unit">米</span>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">标准气压 (QNE)</label>
                <div class="input-wrapper">
                    <input type="number" id="ipt-qne" value="1013.25">
                    <span class="unit">hPa</span>
                </div>
            </div>
            <div class="input-group" style="margin-bottom:0;">
                <label class="input-label">气压梯度系数</label>
                <div class="input-wrapper">
                    <input type="number" id="ipt-coef" value="8.3" step="0.1">
                    <span class="unit">m/hPa</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ===================================
    // 1. 全量中国机场数据库 (Top 240+)
    // ===================================
    const airports = [
        // 华北
        {c:"ZBAA",n:"北京首都",ct:"北京"},{c:"ZBAD",n:"北京大兴",ct:"北京"},{c:"ZBTJ",n:"天津滨海",ct:"天津"},
        {c:"ZBSJ",n:"石家庄正定",ct:"石家庄"},{c:"ZBHH",n:"呼和浩特白塔",ct:"呼和浩特"},{c:"ZYTX",n:"太原武宿",ct:"太原"},
        {c:"ZBYN",n:"太原尧城",ct:"太原"},{c:"ZBDS",n:"鄂尔多斯伊金霍洛",ct:"鄂尔多斯"},{c:"ZBCF",n:"赤峰玉龙",ct:"赤峰"},
        {c:"ZBDT",n:"大同云冈",ct:"大同"},{c:"ZBZL",n:"扎兰屯成吉思汗",ct:"扎兰屯"},{c:"ZBES",n:"二连浩特赛乌苏",ct:"二连浩特"},
        
        // 华东
        {c:"ZSSS",n:"上海虹桥",ct:"上海"},{c:"ZSPD",n:"上海浦东",ct:"上海"},{c:"ZSNJ",n:"南京禄口",ct:"南京"},
        {c:"ZHZH",n:"杭州萧山",ct:"杭州"},{c:"ZSAM",n:"厦门高崎",ct:"厦门"},{c:"ZSOF",n:"合肥新桥",ct:"合肥"},
        {c:"ZSFZ",n:"福州长乐",ct:"福州"},{c:"ZSNB",n:"宁波栎社",ct:"宁波"},{c:"ZSQD",n:"青岛胶东",ct:"青岛"},
        {c:"ZSYT",n:"烟台蓬莱",ct:"烟台"},{c:"ZSJN",n:"济南遥墙",ct:"济南"},{c:"ZSWZ",n:"温州龙湾",ct:"温州"},
        {c:"ZSNT",n:"南通兴东",ct:"南通"},{c:"ZSXZ",n:"徐州观音",ct:"徐州"},{c:"ZSCZ",n:"常州奔牛",ct:"常州"},
        {c:"ZSYW",n:"义乌",ct:"义乌"},{c:"ZSTX",n:"黄山屯溪",ct:"黄山"},{c:"ZSJD",n:"景德镇罗家",ct:"景德镇"},
        {c:"ZSGX",n:"赣州黄金",ct:"赣州"},{c:"ZSLY",n:"临沂舒卒",ct:"临沂"},{c:"ZSRZ",n:"日照山字河",ct:"日照"},

        // 中南
        {c:"ZGGG",n:"广州白云",ct:"广州"},{c:"ZGSZ",n:"深圳宝安",ct:"深圳"},{c:"ZGHA",n:"长沙黄花",ct:"长沙"},
        {c:"ZHHH",n:"武汉天河",ct:"武汉"},{c:"ZGKL",n:"桂林两江",ct:"桂林"},{c:"ZGNN",n:"南宁吴圩",ct:"南宁"},
        {c:"ZJHK",n:"海口美兰",ct:"海口"},{c:"ZJSY",n:"三亚凤凰",ct:"三亚"},{c:"ZHCC",n:"郑州新郑",ct:"郑州"},
        {c:"ZGZJ",n:"湛江吴川",ct:"湛江"},{c:"ZGHZ",n:"惠州平潭",ct:"惠州"},{c:"ZGMX",n:"梅州梅县",ct:"梅州"},
        {c:"ZGSD",n:"珠海金湾",ct:"珠海"},{c:"ZGSY",n:"揭阳潮汕",ct:"揭阳"},{c:"ZHNY",n:"南阳姜营",ct:"南阳"},
        {c:"ZHLY",n:"洛阳北郊",ct:"洛阳"},{c:"ZHYC",n:"宜昌三峡",ct:"宜昌"},{c:"ZHES",n:"恩施许家坪",ct:"恩施"},
        
        // 西南
        {c:"ZUUU",n:"成都双流",ct:"成都"},{c:"ZUTF",n:"成都天府",ct:"成都"},{c:"ZUCK",n:"重庆江北",ct:"重庆"},
        {c:"ZPPP",n:"昆明长水",ct:"昆明"},{c:"ZGYL",n:"贵阳龙洞堡",ct:"贵阳"},{c:"ZULS",n:"拉萨贡嘎",ct:"拉萨"},
        {c:"ZPLJ",n:"丽江三义",ct:"丽江"},{c:"ZPJH",n:"西双版纳嘎洒",ct:"西双版纳"},{c:"ZPDL",n:"大理凤仪",ct:"大理"},
        {c:"ZUMY",n:"绵阳南郊",ct:"绵阳"},{c:"ZUYB",n:"宜宾五粮液",ct:"宜宾"},{c:"ZUZH",n:"攀枝花保安营",ct:"攀枝花"},
        {c:"ZUXC",n:"西昌青山",ct:"西昌"},{c:"ZUNZ",n:"林芝米林",ct:"林芝"},
        
        // 西北
        {c:"ZXYA",n:"西安咸阳",ct:"西安"},{c:"ZLXY",n:"兰州中川",ct:"兰州"},{c:"ZWWW",n:"乌鲁木齐地窝堡",ct:"乌鲁木齐"},
        {c:"ZINC",n:"银川河东",ct:"银川"},{c:"ZNNQ",n:"西宁曹家堡",ct:"西宁"},{c:"ZWSH",n:"喀什",ct:"喀什"},
        {c:"ZWKL",n:"库尔勒",ct:"库尔勒"},{c:"ZWAK",n:"阿克苏",ct:"阿克苏"},{c:"ZWYN",n:"伊宁",ct:"伊宁"},
        {c:"ZLXN",n:"西宁曹家堡",ct:"西宁"},{c:"ZLDH",n:"敦煌莫高",ct:"敦煌"},{c:"ZLJQ",n:"嘉峪关",ct:"嘉峪关"},

        // 东北
        {c:"ZYTX",n:"沈阳桃仙",ct:"沈阳"},{c:"ZYTL",n:"大连周水子",ct:"大连"},{c:"ZYHB",n:"哈尔滨太平",ct:"哈尔滨"},
        {c:"ZYCC",n:"长春龙嘉",ct:"长春"},{c:"ZYCY",n:"朝阳",ct:"朝阳"},{c:"ZYMD",n:"牡丹江海浪",ct:"牡丹江"},
        {c:"ZYJM",n:"佳木斯",ct:"佳木斯"},{c:"ZYDQ",n:"大庆萨尔图",ct:"大庆"},

        // 港澳台
        {c:"VHHH",n:"香港赤鱲角",ct:"香港"},{c:"VMMC",n:"澳门国际",ct:"澳门"},
        {c:"RCTP",n:"台北桃园",ct:"台北"},{c:"RCSS",n:"台北松山",ct:"台北"},{c:"RCKH",n:"高雄小港",ct:"高雄"}
    ];

    let currentIcao = "";
    let lastFetchTime = 0;
    let searchTimer = null;
    let firstMatch = null;
    const UPDATE_INTERVAL = 5 * 60 * 1000;
    const STALE_THRESHOLD = 15 * 60 * 1000; // 15分钟告警

    // ===================================
    // 2. 时钟与倒计时逻辑
    // ===================================
    function updateClock() {
        const now = new Date();
        const days = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
        document.getElementById('clock-time').textContent = now.toLocaleTimeString('zh-CN', {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
        document.getElementById('clock-date').textContent = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日 ${days[now.getDay()]}`;
        
        const timerEl = document.getElementById('update-timer');
        const qnhInput = document.getElementById('ipt-qnh');

        if(currentIcao && lastFetchTime > 0) {
            const age = now.getTime() - lastFetchTime;
            const nextUpdate = lastFetchTime + UPDATE_INTERVAL;
            const diff = Math.max(0, Math.ceil((nextUpdate - now.getTime()) / 1000));
            
            timerEl.style.display = "inline-block";

            // 状态逻辑
            if (age > STALE_THRESHOLD) {
                // 红色告警
                timerEl.textContent = "⚠ 数据过期";
                timerEl.className = "timer-badge error";
                qnhInput.classList.add('alert'); // 输入框变红
            } else {
                qnhInput.classList.remove('alert');
                if (diff > 0) {
                    const min = Math.floor(diff / 60);
                    const sec = diff % 60;
                    timerEl.textContent = `更新: ${min}分${sec}秒`;
                    timerEl.className = "timer-badge"; // 绿色
                } else {
                    timerEl.textContent = "更新中...";
                    timerEl.className = "timer-badge stale";
                }
            }
        } else {
            timerEl.style.display = "none";
            qnhInput.classList.remove('alert');
        }
    }
    setInterval(updateClock, 1000);
    updateClock();

    // ===================================
    // 3. 核心计算
    // ===================================
    function calc() {
        const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
        
        const qnh = getVal('ipt-qnh');
        const qne = getVal('ipt-qne');
        const elev = getVal('ipt-elev');
        const adsb = getVal('ipt-adsb');
        const coef = getVal('ipt-coef');
        
        const diff = qnh - qne;
        const correction = diff * coef;
        const offset = correction - elev; 
        const final = adsb + offset;

        const offsetEl = document.getElementById('res-offset');
        offsetEl.textContent = (offset > 0 ? "+" : "") + offset.toFixed(2) + " 米";
        offsetEl.style.color = offset >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

        document.getElementById('res-final').textContent = Math.round(final);
    }

    ['ipt-qnh', 'ipt-adsb', 'ipt-elev', 'ipt-qne', 'ipt-coef'].forEach(id => {
        document.getElementById(id).addEventListener('input', calc);
    });

    // ===================================
    // 4. 网络请求
    // ===================================
    async function fetchMetar(icao) {
        if(!icao) return;
        
        const ui = {
            badge: document.getElementById('status-badge'),
            dot: document.getElementById('status-dot'),
            txt: document.getElementById('status-text'),
            timer: document.getElementById('update-timer')
        };

        ui.badge.className = "status-badge loading";
        ui.txt.textContent = "更新中...";
        ui.dot.className = "dot blink";

        const ts = Date.now();
        const url = `https://metar.vatsim.net/metar.php?id=${icao}&t=${ts}`;
        const proxyUrl = `https://corsproxy.io/?https://tgftp.nws.noaa.gov/data/observations/metar/stations/${icao}.TXT?t=${ts}`;

        try {
            let res = await fetch(url);
            if(!res.ok) throw new Error("Vatsim fail");
            let text = await res.text();
            
            if(text && text.includes(icao)) success(text, "实时");
            else throw new Error("Invalid");
        } catch (e) {
            try {
                let res2 = await fetch(proxyUrl);
                let text2 = await res2.text();
                if(text2.length > 10) success(text2, "备用源");
                else throw new Error("All fail");
            } catch(e2) {
                ui.badge.className = "status-badge error";
                ui.txt.textContent = "失败";
                ui.dot.className = "dot";
                
                // 失败时，QNH变红
                document.getElementById('ipt-qnh').classList.add('alert');
                ui.timer.textContent = "⚠ 获取失败";
                ui.timer.className = "timer-badge error";
                ui.timer.style.display = "inline-block";
            }
        }

        function success(raw, src) {
            ui.badge.className = "status-badge live";
            ui.txt.textContent = src + "数据";
            ui.dot.className = "dot";
            
            lastFetchTime = Date.now();
            document.getElementById('ipt-qnh').classList.remove('alert');
            
            parseMetarEnhanced(raw);
            calc();
        }
    }

    setInterval(() => {
        if(currentIcao && lastFetchTime > 0) {
            if(Date.now() - lastFetchTime >= UPDATE_INTERVAL) fetchMetar(currentIcao);
        }
    }, 30000);

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'visible' && currentIcao) {
            if(Date.now() - lastFetchTime >= UPDATE_INTERVAL) fetchMetar(currentIcao);
        }
    });

    // ===================================
    // 5. 交互与搜索 (修复显示)
    // ===================================
    const iptSearch = document.getElementById('ipt-search');
    const dropdown = document.getElementById('search-results');
    const displayEl = document.getElementById('airport-display');
    
    iptSearch.addEventListener('input', (e) => {
        const val = e.target.value.toUpperCase();
        dropdown.innerHTML = "";
        clearTimeout(searchTimer);
        firstMatch = null;
        
        if(!val) { dropdown.style.display = 'none'; return; }

        const hits = airports.filter(a => a.c.includes(val) || a.n.includes(val) || a.ct.toUpperCase().includes(val));
        
        if(hits.length > 0) {
            dropdown.style.display = 'block';
            firstMatch = hits[0];
            hits.forEach(a => {
                const div = document.createElement('div');
                div.className = "search-item";
                div.innerHTML = `<strong>${a.c}</strong> - ${a.ct} ${a.n}`;
                div.onmousedown = () => selectAirport(a);
                dropdown.appendChild(div);
            });
        } else if(val.length === 4) {
            dropdown.style.display = 'block';
            const div = document.createElement('div');
            div.className = "search-item";
            div.innerHTML = `自定义代码: <strong>${val}</strong>`;
            const customObj = {c:val, n:"自定义", ct:""};
            firstMatch = customObj;
            div.onmousedown = () => selectAirport(customObj);
            dropdown.appendChild(div);
        } else {
            dropdown.style.display = 'none';
        }

        if(val.length === 4) {
            searchTimer = setTimeout(() => {
                const target = hits.length > 0 ? hits[0] : {c: val, n: "自定义", ct: ""};
                selectAirport(target);
            }, 1000);
        }
    });

    iptSearch.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (firstMatch) { selectAirport(firstMatch); iptSearch.blur(); }
            else if (iptSearch.value.length === 4) { selectAirport({c: iptSearch.value.toUpperCase(), n: "自定义", ct: ""}); iptSearch.blur(); }
        }
    });

    function selectAirport(a) {
        clearTimeout(searchTimer);
        iptSearch.value = a.c;
        currentIcao = a.c;
        dropdown.style.display = 'none';
        
        // 核心修复：确保文字显示
        displayEl.textContent = `${a.ct} ${a.n}国际机场`;
        displayEl.style.display = "block";
        
        fetchMetar(currentIcao);
    }

    document.getElementById('refresh-btn').onclick = () => {
        if(currentIcao) fetchMetar(currentIcao);
        else iptSearch.focus();
    };
    document.addEventListener('click', (e) => { if(e.target !== iptSearch) dropdown.style.display = 'none'; });

    // ===================================
    // 6. 气象解析
    // ===================================
    function parseMetarEnhanced(raw) {
        let qnh = 1013;
        let qMatch = raw.match(/Q(\d{4})/);
        if(qMatch) qnh = parseInt(qMatch[1]);
        else {
            let aMatch = raw.match(/A(\d{4})/);
            if(aMatch) qnh = Math.round(parseInt(aMatch[1])/100 * 33.8639);
        }
        document.getElementById('ipt-qnh').value = qnh;

        const wxBox = document.getElementById('weather-box');
        wxBox.innerHTML = "";

        let wxDesc = "晴 / 良好";
        if (raw.match(/(RA|DZ)/)) wxDesc = "雨";
        if (raw.match(/SN/)) wxDesc = "雪";
        if (raw.match(/TS/)) wxDesc = "雷雨";
        if (raw.match(/(FG|BR)/)) wxDesc = "雾/薄雾";
        if (raw.match(/HZ/)) wxDesc = "霾";
        
        if (wxDesc === "晴 / 良好") {
            if (raw.match(/OVC/)) wxDesc = "阴天 (OVC)";
            else if (raw.match(/BKN/)) wxDesc = "多云 (BKN)";
            else if (raw.match(/SCT/)) wxDesc = "少云 (SCT)";
            else if (raw.match(/FEW/)) wxDesc = "晴间多云";
            else if (raw.match(/CAVOK/)) wxDesc = "晴 (CAVOK)";
        }
        addWxItem("天气现象", wxDesc, raw.match(/(RA|SN|TS|FG|OVC|BKN|CAVOK)/)?.[0] || "--");

        let windStr = "静风";
        let windSub = "0m/s";
        let wMatch = raw.match(/(\d{3}|VRB)(\d{2,3})(KT|MPS)/);
        if(wMatch) {
            let degRaw = wMatch[1];
            let spdRaw = parseInt(wMatch[2]);
            let unit = wMatch[3];
            let mps = (unit === "KT") ? spdRaw * 0.51444 : spdRaw;
            let level = 0;
            if(mps < 0.3) level = 0; else if(mps <= 1.5) level = 1; else if(mps <= 3.3) level = 2; else if(mps <= 5.4) level = 3; else if(mps <= 7.9) level = 4; else if(mps <= 10.7) level = 5; else if(mps <= 13.8) level = 6; else if(mps <= 17.1) level = 7; else level = 8;
            let dirTxt = "";
            if(degRaw === "VRB") { dirTxt = "不定向"; } else {
                let deg = parseInt(degRaw);
                const dirs = ["北风", "东北风", "东风", "东南风", "南风", "西南风", "西风", "西北风", "北风"];
                let idx = Math.round(deg / 45);
                dirTxt = dirs[idx] + " " + deg + "°";
            }
            windStr = `${dirTxt}`;
            windSub = `${level}级 (${mps.toFixed(1)}m/s)`;
        }
        addWxItem("风向风力", windStr, windSub);

        let tmMatch = raw.match(/(M?\d{2})\/(M?\d{2})/);
        if(tmMatch) {
            let t = parseInt(tmMatch[1].replace('M','-'));
            let td = parseInt(tmMatch[2].replace('M','-'));
            let hum = 100 - 5 * (t - td);
            addWxItem("温度", t + "°C");
            addWxItem("相对湿度", "~" + hum + "%");
        }
    }

    function addWxItem(label, val, sub="") {
        const div = document.createElement('div');
        div.className = "wx-item";
        div.innerHTML = `<div class="wx-label">${label}</div><div class="wx-value">${val}</div>${sub ? `<div class="wx-sub">${sub}</div>` : ''}`;
        document.getElementById('weather-box').appendChild(div);
    }

    function toggleAdv() {
        const content = document.getElementById('adv-content');
        const arrow = document.getElementById('adv-arrow');
        if(content.style.display === 'block') { content.classList.remove('show'); setTimeout(()=> content.style.display = 'none', 100); arrow.textContent = "▼"; }
        else { content.style.display = 'block'; setTimeout(()=> content.classList.add('show'), 10); arrow.textContent = "▲"; }
    }
    calc();
</script>

</body>
</html>
